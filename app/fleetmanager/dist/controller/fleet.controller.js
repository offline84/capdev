sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/Dialog","sap/m/MessageToast","sap/m/MessageBox","../utils/validator","sap/ui/model/json/JSONModel","sap/ui/core/format/DateFormat"],function(e,t,i,a,o,r,l,n,s,g){"use strict";var c=e.extend("fleetmanager.controller.fleet",{onInit(){var e={VIN_NUMBER:"",BRAND:"",MODEL:"",COLOR:"",TYPE_OF_CAR_ID:0,FIRST_USE:null};var t=new s(e);this.getView().setModel(t,"vehicleModel");var i={VIN_NUMBER_STATE_TEXT:"",VIN_NUMBER_STATE:"None",BRAND_STATE_TEXT:"",BRAND_STATE:"None",MODEL_STATE_TEXT:"",MODEL_STATE:"None"};var a=new s(i);this.getView().setModel(a,"vehicleStateModel");var o={maxDate:new Date};var r=new s(o);this.getView().setModel(r,"dateModel");var l={VIN_NUMBER:false,BRAND:false,MODEL:false,COLOR:false,TYPE_OF_CAR:false,FIRST_USE:false};var n=new s(l);this.getView().setModel(n,"editableInput")},onSearch:function(e){var a=e.getSource().getValue();if(a||a==""){var o=new t({filters:[new t({path:"MODEL",operator:i.Contains,value1:a,caseSensitive:false},i.Contains,a),new t({path:"BRAND",operator:i.Contains,value1:a,caseSensitive:false},i.Contains,a),new t({path:"COLOR",operator:i.Contains,value1:a,caseSensitive:false},i.Contains,a),new t({path:"TYPE_OF_CAR/CARTYPE",operator:i.Contains,value1:a,caseSensitive:false},i.Contains,a),new t({path:"VIN_NUMBER",operator:i.Contains,value1:a,caseSensitive:false},i.Contains,a)]});var r=this.byId("fleetmanagerTable");var l=r.getBinding("items");l.filter(o,"Application")}},onPressNewVehicleButton:function(){if(!this.oDialog){this.oDialog=this.loadFragment({name:"fleetmanager.fragment.newVehicleDialog"})}this.oDialog.then(function(e){e.open()})},onSubmitPressed:function(){var e=this.getView().getModel("vehicleModel");let t=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var i=null;if(e.getProperty("/FIRST_USE")){i=t.format(e.getProperty("/FIRST_USE"))}let a=e.getProperty("/TYPE_OF_CAR");var o={MODEL:e.getProperty("/MODEL"),BRAND:e.getProperty("/BRAND"),COLOR:e.getProperty("/COLOR"),TYPE_OF_CAR_ID:e.getProperty("/TYPE_OF_CAR"),VIN_NUMBER:e.getProperty("/VIN_NUMBER"),FIRST_USE:i};var r=this.getView().byId("fleetmanagerTable").getBinding("items");if(o.VIN_NUMBER!=""&&o.MODEL!=""&&o.BRAND!=""){try{r.create(o)}catch(e){l.error("An error has occured during creation of the new Vehicle: /n",e)}this.byId("newVehicleDialog").close();for(const[t,i]of Object.entries(o)){if(t=="FIRST_USE"){e.setProperty("/"+t,null)}else e.setProperty("/"+t,"")}}else l.warning("New vehicle contains invalid fields!")},onChangeVinNumber:function(e){var t=n.validateVinNumber(e.getParameter("value"));this.getView().getModel("vehicleStateModel").setProperty("/VIN_NUMBER_STATE",t?"Error":"None");this.getView().getModel("vehicleStateModel").setProperty("/VIN_NUMBER_STATE_TEXT",t?t:null)},onChangeModel:function(e){var t=n.validateModel(e.getParameter("value"));this.getView().getModel("vehicleStateModel").setProperty("/MODEL_STATE",t?"Error":"None");this.getView().getModel("vehicleStateModel").setProperty("/MODEL_STATE_TEXT",t?t:null)},onChangeBrand:function(e){var t=n.validateModel(e.getParameter("value"));this.getView().getModel("vehicleStateModel").setProperty("/BRAND_STATE",t?"Error":"None");this.getView().getModel("vehicleStateModel").setProperty("/BRAND_STATE_TEXT",t?t:null)},onNewVehicleDialogCancelled:function(){this.byId("newVehicleDialog").close();r.show("No vehicle was added")},onDeleteSingleVehiclePressed:function(e){var t=e.getSource().getBindingContext();var i=t.getObject();l.warning("Are you sure you want to delete vehicle "+i.BRAND+" "+i.MODEL+"?",{actions:[l.Action.DELETE,l.Action.CANCEL],emphasizedAction:l.Action.DELETE,onClose:function(e){if(e==="DELETE"){t.delete();if(!t.hasPendingChanges()){r.show("Vehicle was successfully deleted")}}}});this._ViewDetailsDialog.close()},onShowDetailsSingleVehiclePressed:function(e){if(!this._ViewDetailsDialog){this.viewDetailsDialog="detailsVehicleDialog";this._ViewDetailsDialog=new sap.ui.xmlfragment(this.viewDetailsDialog,"fleetmanager.fragment.detailsVehicleDialog",this);this.getView().addDependent(this._ViewDetailsDialog)}var t=e.getSource().getBindingContext();let i=t.getObject();let a=i.FIRST_USE;if(a){i.FIRST_USE=new Date(a)}if(i.TYPE_OF_CAR){i.TYPE_OF_CAR_ID=i.TYPE_OF_CAR.ID}else i.TYPE_OF_CAR_ID=0;var o=new s(i);this._ViewDetailsDialog.setBindingContext(t);this._ViewDetailsDialog.setModel(o,"detailsVehicleModel");let r=this.getView().getModel("editableInput");for(const[e,t]of Object.entries(i)){if(t==""||t==null){r.setProperty("/"+e,true)}else{r.setProperty("/"+e,false)}}this._ViewDetailsDialog.open()},onDetailsVehicleDialogClosePressed:function(){this._ViewDetailsDialog.close()},onEditVehiclePressed:function(e){var t=e.getSource().getBindingContext();var i=this._ViewDetailsDialog.getModel("detailsVehicleModel");var a=t.getObject();var o=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});if(typeof i.getProperty("/FIRST_USE")!=="string"){var r;if(i.getProperty("/FIRST_USE")){r=o.format(i.getProperty("/FIRST_USE"));i.setProperty("/FIRST_USE",r)}}if(a.TYPE_OF_CAR){a.TYPE_OF_CAR_ID=a.TYPE_OF_CAR.ID}else a.TYPE_OF_CAR_ID=0;let n=[];for(const[e,t]of Object.entries(a)){if(e!="TYPE_OF_CAR"){let a=i.getProperty("/"+e);if(a!=t){if(e=="FIRST_USE"){r=o.format(t);if(a!=r){n.push({path:e,data:a})}}else n.push({path:e,data:a})}}}n.forEach(e=>{try{t.setProperty(e.path,e.data)}catch(e){l.error("Updating vehicle encountered an error: /n"+e)}});if(i.getProperty("/FIRST_USE")){i.setProperty("/FIRST_USE",new Date(i.getProperty("/FIRST_USE")))}}});return c});